import { useState, useEffect, useCallback, useRef, Suspense } from "react";
import { useEscapeKey } from "@/hooks/useEscapeKey";
import { usePathPrefix } from "@/hooks/usePathPrefix";
import useMeta from "@/hooks/useMetaTags";

const Logo = () => {
  const [isModalOpen, setModalOpen] = useState(false);
  const [ModalWrapperComponent, setModalWrapper] = useState(null);
  const [PopupComponent, setLogoPopup] = useState(null);
  const pathPrefix = "about";
  const { addPrefix, removePrefix } = usePathPrefix(
    pathPrefix,
    (isPopupPath) => {
      setModalOpen(isPopupPath);
    }
  );

  // состояние для мета-тегов
  const [meta, setMeta] = useState({
    title: "Игры от Честного Эйба",
    description:
      "Честный Эйб — начинающая студия разработки игр, создающая уникальные проекты для геймеров России и СНГ. Наш первый проект уже в разработке и скоро выйдет на RuStore. Следите за новостями, чтобы первыми узнать о релизе и стать частью нашего игрового сообщества!",
  });
  // вызов useMeta с текущими данными
  useMeta(meta);

  // переменная для хранения исходных значений мета-тегов
  const originalMetaRef = useRef({ title: "", description: "" });

  // при первом рендере сохраняем текущие мета-теги как исходные
  useEffect(() => {
    originalMetaRef.current = { ...meta };
  }, []);

  const handleOpenModal = async () => {
    if (!ModalWrapperComponent) {
      const { default: ModalWrapper } = await import(
        "@components/ModalWrapper/ModalWrapper"
      );
      setModalWrapper(() => ModalWrapper);
    }
    if (!PopupComponent) {
      const { default: LogoPopup } = await import(
        "@components/Popups/LogoPopup"
      );
      setLogoPopup(() => LogoPopup);
    }
    // обновляем мета-теги
    setMeta({
      title: "About",
      description: "Описание при открытии модального окна",
    });
    addPrefix();
    setModalOpen(true);
  };

  const handleCloseModal = useCallback(() => {
    removePrefix();
    setModalOpen(false);
    // при закрытии восстанавливаем исходные мета-теги
    setMeta({ ...originalMetaRef.current });
  }, []);

  const descRef = useRef(null);

  const handleBlur = useCallback((element) => {
    if (element) {
      element.blur();
    }
  }, []);

  useEscapeKey(descRef, handleBlur);

  useEffect(() => {
    const path = window.location.pathname;
    if (path.includes(pathPrefix)) {
      Promise.all([
        import("@components/ModalWrapper/ModalWrapper"),
        import("@components/Popups/LogoPopup"),
      ]).then(([{ default: ModalWrapper }, { default: LogoPopup }]) => {
        setModalWrapper(() => ModalWrapper);
        setLogoPopup(() => LogoPopup);
        setModalOpen(true);
        // обновляем мета-теги при открытии
        setMeta({
          title: "Заголовок при открытии модального окна",
          description: "Описание при открытии модального окна",
        });
      });
    }
  }, []);

  return (
    <>
      <button
        id="header-logo"
        className="header__logo"
        aria-label="Честный Эйб"
        onClick={handleOpenModal}
        ref={descRef}
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 1662 480"
          aria-label="Айкис"
          focusable="false"
        >
          <path
            d="M1020 15.061v15.062l25.75-.312 25.75-.311 5.333-2.954c6.744-3.736 9.23-6.72 14.748-17.707L1096.02 0H1020v15.061m375 0v15.062l25.75-.312 25.75-.311 5.333-2.954c6.744-3.736 9.23-6.72 14.748-17.707L1471.02 0H1395v15.061M2.233 127.25c.297 63.567.472 69.701 2.131 74.75 4.963 15.104 15.119 25.393 29.888 30.277 5.505 1.821 9.368 2.117 32.498 2.492l26.25.425V346h45V58H93v132.219l-18.298-.362c-29.796-.59-27.129 6.255-27.488-70.562L46.927 58H1.911l.322 69.25M161 202v144h125v-45h-80v-76h18.451c27.318 0 33.9-2.305 39.799-13.936 2.575-5.077 2.75-6.24 2.75-18.229v-12.806l-30.25-.264-30.25-.265-.262-38.25-.262-38.25H286V58H161v144M330.043 59.559c-12.431 2.695-23.303 11.99-28.186 24.097L299.5 89.5l-.301 109c-.216 78.51.018 110.678.839 115 3.003 15.818 14.971 28.025 30.761 31.376 7.131 1.513 65.275 1.512 72.402-.001 12.726-2.703 24.416-12.246 28.944-23.628 2.039-5.127 2.324-7.797 2.641-24.747l.357-19-21.846-7.25c-12.015-3.988-22.172-7.25-22.571-7.25-.4 0-.726 6.119-.726 13.599 0 22.299-1.52 23.901-22.674 23.901-15.904 0-18.108-.774-21.574-7.571-2.697-5.289-2.697-176.569 0-181.858 2.952-5.791 5.935-7.247 16.018-7.822 13.783-.786 19.728.265 24.088 4.257l3.642 3.335.319 15.517.32 15.516 22.49 7.505 22.49 7.505-.31-34.192L434.5 88.5l-3.165-6.68c-5.875-12.401-14.85-19.55-28.055-22.349-9.431-1.998-63.915-1.933-73.237.088M446 80.5V103h48v243h45V103h49V58H446v22.5M605 202v144h45V225h46v121h45V58h-45v122.038l-22.75-.269-22.75-.269-.258-60.75-.257-60.75H605v144m158 0v144h49.451c32.831 0 51.232-.378 54.75-1.125 12.697-2.696 24.369-12.213 28.978-23.628l2.321-5.747v-106l-3.126-6.5c-4.573-9.509-9.238-14.329-18.122-18.722l-7.64-3.778-30.556-.5-30.556-.5-.258-60.75-.257-60.75H763v144m155 0v144h45V58h-45v144m66 .107v144.107l15.25-.403c17.704-.467 23.566-2.549 31.541-11.2 6.252-6.782 6.489-7.448 29.31-82.111 11.599-37.95 21.296-69.211 21.548-69.47.533-.548-.412 110.479-1.207 141.72l-.541 21.25H1126V57.786l-15.25.359c-17.484.411-23.263 2.316-31.248 10.3-6.251 6.251-6.933 8.147-29.563 82.055-11.619 37.95-21.357 69.225-21.639 69.5-.283.275-.183-36.062.222-80.75l.735-81.25H984v144.107m246.043-142.548c-12.442 2.697-23.336 12.018-28.166 24.097-2.239 5.602-2.35 7.115-2.671 36.538l-.336 30.693 22.565-7.529 22.565-7.53.002-10.664c.002-17.301 3.063-21.077 17.768-21.915 13.786-.786 19.728.264 24.088 4.259l3.642 3.336.287 34.578.288 34.578H1241v11.822c0 25.708 6.802 32.363 33.75 33.02l15.25.372v32.492c0 43.528.482 42.563-21.5 43.084-20.696.492-23.799-2.105-24.336-20.36-.185-6.286-.624-11.43-.976-11.43-.351 0-10.438 3.255-22.414 7.233L1199 283.466v12.718c0 14.985 1.133 21.258 5.249 29.068 5.225 9.913 15.066 17.187 26.55 19.624 7.131 1.513 65.275 1.512 72.402-.001 12.697-2.696 24.369-12.213 28.978-23.628l2.321-5.747v-227l-3.165-6.68c-5.875-12.401-14.85-19.55-28.055-22.349-9.431-1.998-63.915-1.933-73.237.088M1359 202.107v144.107l15.25-.403c17.704-.467 23.566-2.549 31.541-11.2 6.252-6.782 6.489-7.448 29.31-82.111 11.599-37.95 21.296-69.211 21.548-69.47.533-.548-.412 110.479-1.207 141.72l-.541 21.25H1501V57.786l-15.25.359c-17.484.411-23.263 2.316-31.248 10.3-6.251 6.251-6.933 8.147-29.563 82.055-11.619 37.95-21.357 69.225-21.639 69.5-.283.275-.183-36.062.222-80.75l.735-81.25H1359v144.107m164-.107v144h49.451c32.831 0 51.232-.378 54.75-1.125 12.697-2.696 24.369-12.213 28.978-23.628l2.321-5.747v-106l-3.126-6.5c-4.573-9.509-9.238-14.329-18.122-18.722l-7.64-3.778-30.556-.5-30.556-.5-.262-38.25-.262-38.25 17.762.002c25.945.002 28.258 1.693 28.26 20.665l.002 10.167 21.25 7.166c11.688 3.942 21.813 7.392 22.5 7.667 2.064.825 1.76-56.561-.338-63.735-4.037-13.805-14.521-23.187-28.877-25.841-3.757-.694-24.01-1.091-55.719-1.091H1523v144m-715 61.078v38.078l18.75-.328c28.307-.495 27.25 1.001 27.25-38.581 0-38.475.943-37.209-27.75-37.232L808 225v38.078m760 0v38.078l18.75-.328c28.307-.495 27.25 1.001 27.25-38.581 0-38.475.943-37.209-27.75-37.232L1568 225v38.078M923 385.5v3.5h7.545c6.678 0 7.828-.282 10-2.455 4.051-4.05 3.229-4.545-7.545-4.545h-10v3.5M21.963 400.75c-4.313 3.864-4.526 5.995-3.963 39.584l.5 29.834 3.266 2.916c3.123 2.789 3.68 2.916 12.799 2.916 18.15 0 17.935.468 17.935-39s.215-39-17.935-39c-8.99 0-9.709.157-12.602 2.75M60 437v39h12.099c20.301 0 22.267-2.056 21.739-22.73-.453-17.722-1.135-18.538-16.106-19.27l-10.232-.5-.278-14.354-.278-14.354 8.609.354c10.106.416 11.447 1.472 11.447 9.019 0 4.286.307 4.942 2.95 6.309 4.158 2.15 4.05 2.312 4.05-6.07C94 400.539 90.611 398 72.099 398H60v39m44.004-4.75c.005 46.779-2.311 43.75 33.446 43.75H161v-2.3c0-3.194-1.826-4.7-5.7-4.7H152v-71h-8v71.095l-6.25-.297-6.25-.298-.263-35.25-.263-35.25H124v71h-4.045c-2.962 0-4.703-.657-6.5-2.455L111 464.091V398h-7l.004 34.25M168 437v39h32v-7h-25.055l.278-14.25.277-14.25 6.958-.3c7.367-.318 9.542-1.295 9.542-4.282 0-1.611-1.016-1.873-8.25-2.128l-8.25-.29-.277-14.25-.278-14.25H200v-7h-32v39m43.844-36.745c-4.725 3.994-4.844 4.898-4.844 36.729 0 32.522.208 33.956 5.414 37.368 3.486 2.284 20.144 2.347 23.369.087 5.777-4.046 7.111-13.408 2.267-15.913-4.004-2.071-4.05-2.045-4.05 2.251 0 6.563-2.019 8.223-10 8.223-10.348 0-10.003 1.087-9.985-31.473.018-32.91-.278-31.905 9.51-32.328 8.524-.369 10.475 1.257 10.475 8.727 0 4.391.233 4.814 3.5 6.373l3.5 1.669v-7.534c0-13.55-2.982-16.436-16.973-16.429-8.414.004-9.837.267-12.183 2.25M248 401.5v3.5h14v71h7v-71h15v-7h-36v3.5m40 35.5v39h12.099c19.968 0 21.901-1.893 21.901-21.45 0-12.088-.107-12.748-2.455-15.095L317.091 437l2.454-2.455c2.348-2.347 2.455-3.007 2.455-15.095 0-19.557-1.933-21.45-21.901-21.45H288v39m46.963-36.25c-4.313 3.864-4.526 5.995-3.963 39.584l.5 29.834 3.266 2.916c3.123 2.789 3.68 2.916 12.799 2.916 18.15 0 17.935.468 17.935-39s.215-39-17.935-39c-8.99 0-9.709.157-12.602 2.75m60.881-.495c-4.725 3.994-4.844 4.898-4.844 36.729 0 32.522.208 33.956 5.414 37.368 3.486 2.284 20.144 2.347 23.369.087 5.777-4.046 7.111-13.408 2.267-15.913-4.004-2.071-4.05-2.045-4.05 2.251 0 6.563-2.019 8.223-10 8.223-10.348 0-10.003 1.087-9.985-31.473.018-32.91-.278-31.905 9.51-32.328 8.524-.369 10.475 1.257 10.475 8.727 0 4.391.233 4.814 3.5 6.373l3.5 1.669v-7.534c0-13.55-2.982-16.436-16.973-16.429-8.414.004-9.837.267-12.183 2.25m60.119.495c-4.313 3.864-4.526 5.995-3.963 39.584l.5 29.834 3.266 2.916c3.123 2.789 3.68 2.916 12.799 2.916 18.15 0 17.935.468 17.935-39s.215-39-17.935-39c-8.99 0-9.709.157-12.602 2.75M494 437v39h7v-71h10.8c11.472 0 13.2-.615 13.2-4.7V398h-31v39m36 0v39h6.954l.273-17.75.273-17.75 10.232-.5c14.971-.732 15.653-1.548 16.106-19.27.528-20.674-1.438-22.73-21.739-22.73H530v39m52.085-37.25c-1.816 1.487-3.232 7.34-9.44 39L565.342 476h3.746c4.065 0 4.406-.732 6.524-13.977l.644-4.023h8.804c9.994 0 9.032-.938 11.024 10.75l1.236 7.25h3.84c2.112 0 3.84-.301 3.84-.669 0-.369-3.375-17.676-7.5-38.462-4.125-20.786-7.5-38.035-7.5-38.331 0-1.292-5.974-.378-7.915 1.212M611 437v39h6.954l.273-17.75.273-17.75 9.75-.286 9.75-.286V476h7v-78h-7v36.072l-9.75-.286-9.75-.286-.273-17.75-.273-17.75H611v39m44 0v39h2.811c4.962 0 6.463-2.835 16.728-31.592L684.5 416.5l.265 29.75.265 29.75H692v-78h-2.811c-4.962 0-6.463 2.835-16.728 31.592L662.5 457.5l-.265-29.75-.265-29.75H655v39m44-22.45c0 23.604 1.267 25.45 17.465 25.45H726v36h7v-78h-7V434.257l-8.165-.473c-11.743-.68-11.835-.838-11.835-20.395V398h-7v16.55M743 437v39h32v-7h-25.055l.278-14.25.277-14.25 6.958-.3c7.367-.318 9.542-1.295 9.542-4.282 0-1.611-1.016-1.873-8.25-2.128l-8.25-.29-.277-14.25-.278-14.25H775v-7h-32v39m41 0v39h6.954l.273-17.75.273-17.75 9.75-.286 9.75-.286V476h7v-78h-7v36.072l-9.75-.286-9.75-.286-.273-17.75-.273-17.75H784v39m44 0v39h6.954l.273-17.75.273-17.75 9.75-.286 9.75-.286V476h7v-78h-7v36.072l-9.75-.286-9.75-.286-.273-17.75-.273-17.75H828v39m46.963-36.25c-4.313 3.864-4.526 5.995-3.963 39.584l.5 29.834 3.266 2.916c3.123 2.789 3.68 2.916 12.799 2.916 18.15 0 17.935.468 17.935-39s.215-39-17.935-39c-8.99 0-9.709.157-12.602 2.75M914 437v39h2.811c4.962 0 6.463-2.835 16.728-31.592L943.5 416.5l.265 29.75.265 29.75H951v-78h-2.811c-4.962 0-6.463 2.835-16.728 31.592L921.5 457.5l-.265-29.75-.265-29.75H914v39m66.963-36.25c-4.313 3.864-4.526 5.995-3.963 39.584l.5 29.834 3.266 2.916c3.123 2.789 3.68 2.916 12.799 2.916 18.15 0 17.935.468 17.935-39s.215-39-17.935-39c-8.99 0-9.709.157-12.602 2.75m35.037.75v3.5h14v71h7v-71h15v-7h-36v3.5m41 35.5v39h12.099c19.968 0 21.901-1.893 21.901-21.45 0-12.088-.107-12.748-2.455-15.095l-2.454-2.455 2.454-2.455c2.348-2.347 2.455-3.007 2.455-15.095 0-19.557-1.933-21.45-21.901-21.45H1057v39m44 0v39h32v-7h-25.055l.278-14.25.277-14.25 6.958-.3c7.367-.318 9.542-1.295 9.542-4.282 0-1.611-1.016-1.873-8.25-2.128l-8.25-.29-.277-14.25-.278-14.25H1133v-7h-32v39m37-35.5v3.5h14v71h7v-71h15v-7h-36v3.5m45.844-1.245c-4.725 3.994-4.844 4.898-4.844 36.729 0 32.522.208 33.956 5.414 37.368 3.486 2.284 20.144 2.347 23.369.087 5.777-4.046 7.111-13.408 2.267-15.913-4.004-2.071-4.05-2.045-4.05 2.251 0 6.563-2.019 8.223-10 8.223-10.348 0-10.003 1.087-9.985-31.473.018-32.91-.278-31.905 9.51-32.328 8.524-.369 10.475 1.257 10.475 8.727 0 4.391.233 4.814 3.5 6.373l3.5 1.669v-7.534c0-13.55-2.982-16.436-16.973-16.429-8.414.004-9.837.267-12.183 2.25M1219 401.5v3.5h14v71h7v-71h15v-7h-36v3.5m41 35.5v39h12.099c19.968 0 21.901-1.893 21.901-21.45 0-12.088-.107-12.748-2.455-15.095l-2.454-2.455 2.454-2.455c2.348-2.347 2.455-3.007 2.455-15.095 0-19.557-1.933-21.45-21.901-21.45H1260v39m44 0v39h32v-7h-25.055l.278-14.25.277-14.25 6.958-.3c7.367-.318 9.542-1.295 9.542-4.282 0-1.611-1.016-1.873-8.25-2.128l-8.25-.29-.277-14.25-.278-14.25H1336v-7h-32v39m40 0v39h6.954l.273-17.75.273-17.75 9.75-.286 9.75-.286V476h7v-78h-7v36.072l-9.75-.286-9.75-.286-.273-17.75-.273-17.75H1344v39m44 0v39h6.954l.273-17.75.273-17.75 9.75-.286 9.75-.286V476h7v-78h-7v36.072l-9.75-.286-9.75-.286-.273-17.75-.273-17.75H1388v39m47.963-36.25c-4.313 3.864-4.526 5.995-3.963 39.584l.5 29.834 3.266 2.916c3.123 2.789 3.68 2.916 12.799 2.916 18.15 0 17.935.468 17.935-39s.215-39-17.935-39c-8.99 0-9.709.157-12.602 2.75m43.881-.495c-4.725 3.994-4.844 4.898-4.844 36.729 0 32.522.208 33.956 5.414 37.368 3.486 2.284 20.144 2.347 23.369.087 5.777-4.046 7.111-13.408 2.267-15.913-4.004-2.071-4.05-2.045-4.05 2.251 0 6.563-2.019 8.223-10 8.223-10.348 0-10.003 1.087-9.985-31.473.018-32.91-.278-31.905 9.51-32.328 8.524-.369 10.475 1.257 10.475 8.727 0 4.391.233 4.814 3.5 6.373l3.5 1.669v-7.534c0-13.55-2.982-16.436-16.973-16.429-8.414.004-9.837.267-12.183 2.25M1515 401.5v3.5h14v71h7v-71h15v-7h-36v3.5m41 35.5v39h12.099c19.853 0 21.901-1.959 21.901-20.954 0-18.485-1.417-20.305-16.398-21.046l-10.102-.5-.273-17.75-.273-17.75H1556v39m43 0v39h6.954l.273-17.75.273-17.75h5l.5 14.835.5 14.836 3.266 2.914c3.096 2.764 3.734 2.915 12.299 2.915 17.897 0 17.935-.082 17.935-39 0-38.958-.02-39-18.05-39-9.073 0-9.179.029-12.55 3.4-2.202 2.202-3.425 4.404-3.47 6.25a2816.58 2816.58 0 0 0-.25 14.35l-.18 11.5h-5l-.273-17.75-.273-17.75H1599v39M26.655 406.829c-2.65 2.928-2.492 58.104.174 60.516 1.961 1.775 13.499 2.368 15.939.819C45.323 466.543 46 460.016 46 437c0-23.016-.677-29.543-3.232-31.164-2.641-1.677-14.35-.955-16.113.993m268.568 12.421.277 14.25h7.84c10.782 0 11.66-1.1 11.66-14.611 0-13.039-.736-13.889-12.027-13.889h-8.028l.278 14.25m44.432-12.421c-2.65 2.928-2.492 58.104.174 60.516 1.961 1.775 13.499 2.368 15.939.819C358.323 466.543 359 460.016 359 437c0-23.016-.677-29.543-3.232-31.164-2.641-1.677-14.35-.955-16.113.993m121 0c-2.65 2.928-2.492 58.104.174 60.516 1.961 1.775 13.499 2.368 15.939.819C479.323 466.543 480 460.016 480 437c0-23.016-.677-29.543-3.232-31.164-2.641-1.677-14.35-.955-16.113.993m76.568 12.421.277 14.25h7.84c10.782 0 11.66-1.1 11.66-14.611 0-13.039-.736-13.889-12.027-13.889h-8.028l.278 14.25m342.432-12.421c-2.65 2.928-2.492 58.104.174 60.516 1.961 1.775 13.499 2.368 15.939.819C898.323 466.543 899 460.016 899 437c0-23.016-.677-29.543-3.232-31.164-2.641-1.677-14.35-.955-16.113.993m106 0c-2.65 2.928-2.492 58.104.174 60.516 1.961 1.775 13.499 2.368 15.939.819 2.555-1.621 3.232-8.148 3.232-31.164 0-23.016-.677-29.543-3.232-31.164-2.641-1.677-14.35-.955-16.113.993m78.568 12.421.277 14.25h7.84c10.782 0 11.66-1.1 11.66-14.611 0-13.039-.736-13.889-12.027-13.889h-8.028l.278 14.25m203 0 .277 14.25h7.84c10.782 0 11.66-1.1 11.66-14.611 0-13.039-.736-13.889-12.027-13.889h-8.028l.278 14.25m173.432-12.421c-2.65 2.928-2.492 58.104.174 60.516 1.961 1.775 13.499 2.368 15.939.819 2.555-1.621 3.232-8.148 3.232-31.164 0-23.016-.677-29.543-3.232-31.164-2.641-1.677-14.35-.955-16.113.993m180 0c-1.459 1.611-1.655 5.213-1.655 30.345 0 33.209-.419 31.826 9.638 31.826 10.389 0 9.862 1.711 9.862-32 0-33.771.555-32-10.036-32-4.692 0-6.547.434-7.809 1.829M585.095 412c-1.168 5.314-7.094 36.849-7.094 37.75-.001.889 2.165 1.25 7.499 1.25 4.125 0 7.471-.337 7.436-.75-.142-1.653-7.739-38.715-7.841-38.25M295.75 440.562c-.413.424-.75 6.996-.75 14.605V469h8c11.261 0 12-.856 12-13.889 0-13.117-.815-14.211-11.072-14.854-4.085-.257-7.765-.119-8.178.305m769 0c-.412.424-.75 6.996-.75 14.605V469h8c11.261 0 12-.856 12-13.889 0-13.117-.815-14.211-11.072-14.854-4.085-.257-7.766-.119-8.178.305m203 0c-.412.424-.75 6.996-.75 14.605V469h8c11.261 0 12-.856 12-13.889 0-13.117-.815-14.211-11.072-14.854-4.085-.257-7.766-.119-8.178.305M67 455.103v14.102l8.581-.352C86.622 468.399 87 467.941 87 455.031 87 441.684 86.437 441 75.443 441H67v14.103m1496 0v14.102l8.581-.352c11.041-.454 11.419-.912 11.419-13.822 0-13.347-.563-14.031-11.557-14.031H1563v14.103"
            fillRule="evenodd"
          />
        </svg>
      </button>

      {isModalOpen && ModalWrapperComponent && PopupComponent && (
        <Suspense>
          <ModalWrapperComponent
            isOpen={isModalOpen}
            onClose={handleCloseModal}
          >
            <PopupComponent />
          </ModalWrapperComponent>
        </Suspense>
      )}
    </>
  );
};

export default Logo;
